<!DOCTYPE html>
<!-- https://programs.aeondrums.com/lgff-sample -->
<html>
<head>
<title>RandomStringGenerator</title>
<meta charset="utf8" />
<style>
body, input {
    font-size: 20px;
}
textarea {
    font-size: 28px;
    width: 70%;
}
div > p {
    line-height: 10%;
}
</style>
</head>
<body>

<p>Length <input type='number' id='inputLength' value='16' min='1' /></p>
<p>Group <input type='number' id='inputGroup' value='4' min='0' /></p>
<p>Timer <input type='number' id='inputTimer' value='30' min='1' /></p>
<p>R <input type='number' id='inputR' value='4' min='0' /></p>
<p>L <input type='number' id='inputL' value='4' min='0' /></p>
<p>K <input type='number' id='inputK' value='2' min='0' /></p>
<p>F <input type='number' id='inputF' value='1' min='0' /></p>
<input type='button' id='inputGen' value='Generate' /><br />
<textarea spellcheck='false' readonly></textarea>
<div></div>

<script>
"use strict";

const ERROR_BG = 'pink';
const inputLength = document.querySelector('#inputLength');
const inputGroup = document.querySelector('#inputGroup');
const inputTimer = document.querySelector('#inputTimer');
const inputR = document.querySelector('#inputR');
const inputL = document.querySelector('#inputL');
const inputK = document.querySelector('#inputK');
const inputF = document.querySelector('#inputF');
const inputGen = document.querySelector('#inputGen');
const textarea = document.querySelector('textarea');
const div = document.querySelector('div');
const constraints = [inputLength, inputGroup, inputTimer,
                     inputR, inputL, inputK, inputF];
const timerInfo = {'value': 30 * 1000, 'start': new Date().getTime()};

const updateTimerInfo = function() {
};

inputGen.onclick = function() {
    for (let obj of constraints) {
        if (obj.value.match(/^\d+$/)) {
            obj.style.backgroundColor = '';
        } else {
            obj.style.backgroundColor = ERROR_BG;
            textarea.innerHTML = '(invalid inputs)';
            return;
        }
    }
    const totalLength = parseInt(inputLength.value);
    const groupCount = parseInt(inputGroup.value);
    const components = [
        ['R', parseInt(inputR.value)],
        ['L', parseInt(inputL.value)],
        ['K', parseInt(inputK.value)],
        ['F', parseInt(inputF.value)],
    ];
    let resultString = [];
    let resultLength = 0;
    let retriedTimes = 0;
    let currSymbol = 0;
    let currRepeat = 0;
    while (resultLength < totalLength && retriedTimes < 50) {
        let entry = components[Math.floor(Math.random() * 4)];
        let symbol = entry[0];
        let limit = entry[1];
        if (currSymbol == symbol) {
            if (currRepeat >= limit) {
                ++retriedTimes;
                continue;
            } else {
                ++currRepeat;
            }
        } else if (limit > 0) {
            currSymbol = symbol;
            currRepeat = 1;
        } else {
            ++retriedTimes;
            continue;
        }
        retriedTimes = 0;
        resultString.push(currSymbol);
        if (++resultLength % groupCount == 0)
            resultString.push(' ');
    }

    if (retriedTimes == 0) {
        textarea.innerHTML = resultString.join('');
        let element = document.createElement('p');
        element.innerHTML = textarea.innerHTML;
        div.insertBefore(element, div.firstChild);
        // update
        timerInfo['value'] = parseInt(inputTimer.value) * 1000;
        timerInfo['start'] = new Date().getTime();
    } else {
        textarea.innerHTML = '(no solution or try again)';
    }
};

const render = function() {
    let current = new Date().getTime();
    let remain = timerInfo['value'] - (current - timerInfo['start']);
    if (remain > 0) {
        inputGen.value = 'Generate ' + ~~(remain / 1000);
    } else {
        inputGen.onclick();
    }
    window.requestAnimationFrame(render);
};

window.onload = function() {
    window.requestAnimationFrame(render);
};

</script>
</body>
</html>
